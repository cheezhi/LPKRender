/**
 * LPKRender v1.0.0
 * 项目地址：https://github.com/cheezhi/LPKRender
 * @license MIT
 */
!function(e){"use strict";function t(e){return new Promise(((t,i)=>{if(document.querySelector(`script[src="${e}"]`))return void t();const o=document.createElement("script");o.src=e,o.onload=t,o.onerror=i,document.head.appendChild(o)}))}function i(e){let t=0n;for(let i=0;i<e.length;i++)t=31n*t+BigInt(e.charCodeAt(i))&0xffffffffn;return 0x80000000n&t&&(t|=0xffffffff00000000n),t}function o(e,t){const i=[];let o="bigint"==typeof e?e:BigInt(e);for(let e=0;e<t.length;e+=1024){const n=t.subarray(e,e+1024);let r=o;for(let e=0;e<n.length;e++){r=65535n&2531011n+214013n*r>>16n,i.push(Number(0xffn&r)^n[e])}}return new Uint8Array(i)}function n(e){const t=e.match(/[0-9a-f]{32}\.bin3?/g);return t?t[0]:null}function*r(e,t){t=t||"";for(const i in e){const o=t?`${t}_${i}`:i;"object"!=typeof e[i]||null===e[i]||Array.isArray(e[i])?Array.isArray(e[i])?yield*s(e[i],o):yield[o,e[i]]:yield*r(e[i],o)}}function*s(e,t){t=t||"";for(let i=0;i<e.length;i++){const o=t?`${t}_${i}`:String(i);"object"!=typeof e[i]||null===e[i]||Array.isArray(e[i])?Array.isArray(e[i])?yield*s(e[i],o):yield[o,e[i]]:yield*r(e[i],o)}}function a(e,t,o){if("STM_1_0"===e.type&&"true"===e.encrypt){if(!o||!o.fileId||!o.metaData)throw new Error("Steam Workshop LPK需要config.json文件进行解密");return i(e.id+o.fileId+t+o.metaData)}return"STD2_0"===e.type?i(e.id+t):0n}function l(e){let t="";const i=new Uint8Array(e),o=i.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(i[e]);return window.btoa(t)}function d(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",gif:"image/gif",bmp:"image/bmp",tga:"image/x-tga",json:"application/json",moc3:"application/octet-stream","motion3.json":"application/json","physic3.json":"application/json","exp3.json":"application/json","pose.json":"application/json",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg"}[e.split(".").pop().toLowerCase()]||"application/octet-stream"}class p{constructor(e){e=e||{},this.options={lpkFile:e.lpkFile||"/model.lpk",configFile:e.configFile||null,manualConfig:e.manualConfig||{},width:e.width||300,height:e.height||400,position:e.position||"right",bottom:void 0!==e.bottom?e.bottom:0,right:void 0!==e.right?e.right:0,left:e.left||"auto",scale:e.scale||.15,mobileScale:e.mobileScale||null,mobileWidth:e.mobileWidth||null,mobileHeight:e.mobileHeight||null,mobilePosition:e.mobilePosition||null,mobileBottom:e.mobileBottom||null,modelX:void 0!==e.modelX?e.modelX:.5,modelY:void 0!==e.modelY?e.modelY:.5,modelYOffset:void 0!==e.modelYOffset?e.modelYOffset:50,mobileModelX:e.mobileModelX||null,mobileModelY:e.mobileModelY||null,mobileModelYOffset:e.mobileModelYOffset||null,draggable:!1!==e.draggable,clickable:!1!==e.clickable,hitAreaMapping:e.hitAreaMapping||null,soundEnabled:!0===e.soundEnabled,tapMotion:!1!==e.tapMotion,randomMotion:!0===e.randomMotion,excludeMotions:e.excludeMotions||[],idleMotion:e.idleMotion||null,libUrls:e.libUrls||{}},this.container=null,this.canvas=null,this.app=null,this.model=null,this.fileDataUrls={},this.extractedFiles={},this.motionGroups={},this.isLoopingRestore=!1,this.loaded=!1}async init(){await this.createContainer(),await this.loadDependencies(),await this.loadModel()}isMobile(){return window.innerWidth<768}getResponsiveOption(e,t){var i=this.isMobile(),o=this.options[t];return i&&null!=o?o:this.options[e]}async createContainer(){var e=this.getResponsiveOption("width","mobileWidth"),t=this.getResponsiveOption("height","mobileHeight"),i=this.getResponsiveOption("position","mobilePosition"),o=this.getResponsiveOption("bottom","mobileBottom");this.container=document.createElement("div"),this.container.id="live2d-widget-container";var n="position: fixed;";n+="left"===i?" left: 0; right: auto;":" right: "+(this.options.right||0)+"px; left: auto;",n+=" bottom: "+o+"px;",n+=" width: "+e+"px;",n+=" height: "+t+"px;",n+=" z-index: 99999;",n+=" pointer-events: none;",n+=" user-select: none;",n+=" -webkit-user-select: none;",this.container.style.cssText=n,this.canvas=document.createElement("canvas"),this.canvas.id="live2d-widget-canvas",this.canvas.width=e,this.canvas.height=t,this.canvas.style.cssText="width: 100%; height: 100%; pointer-events: auto; display: block;",this.container.appendChild(this.canvas),document.body.appendChild(this.container)}async loadDependencies(){for(var e=this.options.libUrls||{},i=[e.cubismCore||"https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js",e.live2d||"https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js",e.pixi||"https://cdn.jsdelivr.net/npm/pixi.js@7.3.2/dist/pixi.min.js",e.pixiLive2d||"https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"],o=0;o<i.length;o++)document.querySelector('script[src="'+i[o]+'"]')||await t(i[o])}async loadRealJSZip(){if(window.JSZip)return window.JSZip;var e=(this.options.libUrls||{}).jszip||"https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";return await t(e),window.JSZip}async loadModel(){try{var e=await fetch(this.options.lpkFile);if(!e.ok)throw new Error("无法加载 LPK 文件: "+this.options.lpkFile);var t=await e.arrayBuffer(),i=new File([t],this.options.lpkFile.split("/").pop(),{type:"application/zip"}),o=null;if(Object.keys(this.options.manualConfig).length>0)o=this.options.manualConfig;else if(this.options.configFile)try{var n=await fetch(this.options.configFile);n.ok&&(o=await n.json())}catch(e){console.log("未找到 config.json，将尝试无配置模式加载")}var r=await this.loadRealJSZip(),s=await this.unpackLPK(i,o,r);for(var a in this.extractedFiles=s.files,this.fileDataUrls={},this.extractedFiles)if(this.extractedFiles.hasOwnProperty(a)){var p=d(a),c=l(this.extractedFiles[a]);this.fileDataUrls[a]="data:"+p+";base64,"+c}this.setupInterceptors(),await this.initPixi(s.modelFileName)}catch(e){console.error("Live2D 加载失败:",e),this.showError(e.message)}}async unpackLPK(e,t,i){var o=await i.loadAsync(e),n=function(e){function t(e,t){return e<<t|e>>>32-t}function i(e,t){var i,o,n,r,s;return n=2147483648&e,r=2147483648&t,s=(1073741823&e)+(1073741823&t),(i=1073741824&e)&(o=1073741824&t)?2147483648^s^n^r:i|o?1073741824&s?3221225472^s^n^r:1073741824^s^n^r:s^n^r}function o(e,o,n,r,s,a,l){return e=i(e,i(i(function(e,t,i){return e&t|~e&i}(o,n,r),s),l)),i(t(e,a),o)}function n(e,o,n,r,s,a,l){return e=i(e,i(i(function(e,t,i){return e&i|t&~i}(o,n,r),s),l)),i(t(e,a),o)}function r(e,o,n,r,s,a,l){return e=i(e,i(i(function(e,t,i){return e^t^i}(o,n,r),s),l)),i(t(e,a),o)}function s(e,o,n,r,s,a,l){return e=i(e,i(i(function(e,t,i){return t^(e|~i)}(o,n,r),s),l)),i(t(e,a),o)}function a(e){var t,i="",o="";for(t=0;t<=3;t++)i+=(o="0"+(e>>>8*t&255).toString(16)).substr(o.length-2,2);return i}var l,d,p,c,h,f,u,m,g,v;for(e=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var o=e.charCodeAt(i);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t}(e),l=function(e){for(var t,i=e.length,o=i+8,n=16*((o-o%64)/64+1),r=new Array(n-1),s=0,a=0;a<i;)s=a%4*8,r[t=(a-a%4)/4]=r[t]|e.charCodeAt(a)<<s,a++;return s=a%4*8,r[t=(a-a%4)/4]=r[t]|128<<s,r[n-2]=i<<3,r[n-1]=i>>>29,r}(e),u=1732584193,m=4023233417,g=2562383102,v=271733878,d=0;d<l.length;d+=16)p=u,c=m,h=g,f=v,u=o(u,m,g,v,l[d+0],7,3614090360),v=o(v,u,m,g,l[d+1],12,3905402710),g=o(g,v,u,m,l[d+2],17,606105819),m=o(m,g,v,u,l[d+3],22,3250441966),u=o(u,m,g,v,l[d+4],7,4118548399),v=o(v,u,m,g,l[d+5],12,1200080426),g=o(g,v,u,m,l[d+6],17,2821735955),m=o(m,g,v,u,l[d+7],22,4249261313),u=o(u,m,g,v,l[d+8],7,1770035416),v=o(v,u,m,g,l[d+9],12,2336552879),g=o(g,v,u,m,l[d+10],17,4294925233),m=o(m,g,v,u,l[d+11],22,2304563134),u=o(u,m,g,v,l[d+12],7,1804603682),v=o(v,u,m,g,l[d+13],12,4254626195),g=o(g,v,u,m,l[d+14],17,2792965006),u=n(u,m=o(m,g,v,u,l[d+15],22,1236535329),g,v,l[d+1],5,4129170786),v=n(v,u,m,g,l[d+6],9,3225465664),g=n(g,v,u,m,l[d+11],14,643717713),m=n(m,g,v,u,l[d+0],20,3921069994),u=n(u,m,g,v,l[d+5],5,3593408605),v=n(v,u,m,g,l[d+10],9,38016083),g=n(g,v,u,m,l[d+15],14,3634488961),m=n(m,g,v,u,l[d+4],20,3889429448),u=n(u,m,g,v,l[d+9],5,568446438),v=n(v,u,m,g,l[d+14],9,3275163606),g=n(g,v,u,m,l[d+3],14,4107603335),m=n(m,g,v,u,l[d+8],20,1163531501),u=n(u,m,g,v,l[d+13],5,2850285829),v=n(v,u,m,g,l[d+2],9,4243563512),g=n(g,v,u,m,l[d+7],14,1735328473),u=r(u,m=n(m,g,v,u,l[d+12],20,2368359562),g,v,l[d+5],4,4294588738),v=r(v,u,m,g,l[d+8],11,2272392833),g=r(g,v,u,m,l[d+11],16,1839030562),m=r(m,g,v,u,l[d+14],23,4259657740),u=r(u,m,g,v,l[d+1],4,2763975236),v=r(v,u,m,g,l[d+4],11,1272893353),g=r(g,v,u,m,l[d+7],16,4139469664),m=r(m,g,v,u,l[d+10],23,3200236656),u=r(u,m,g,v,l[d+13],4,681279174),v=r(v,u,m,g,l[d+0],11,3936430074),g=r(g,v,u,m,l[d+3],16,3572445317),m=r(m,g,v,u,l[d+6],23,76029189),u=r(u,m,g,v,l[d+9],4,3654602809),v=r(v,u,m,g,l[d+12],11,3873151461),g=r(g,v,u,m,l[d+15],16,530742520),u=s(u,m=r(m,g,v,u,l[d+2],23,3299628645),g,v,l[d+0],6,4096336452),v=s(v,u,m,g,l[d+7],10,1126891415),g=s(g,v,u,m,l[d+14],15,2878612391),m=s(m,g,v,u,l[d+5],21,4237533241),u=s(u,m,g,v,l[d+12],6,1700485571),v=s(v,u,m,g,l[d+3],10,2399980690),g=s(g,v,u,m,l[d+10],15,4293915773),m=s(m,g,v,u,l[d+1],21,2240044497),u=s(u,m,g,v,l[d+8],6,1873313359),v=s(v,u,m,g,l[d+15],10,4264355552),g=s(g,v,u,m,l[d+6],15,2734768916),m=s(m,g,v,u,l[d+13],21,1309151649),u=s(u,m,g,v,l[d+4],6,4149444226),v=s(v,u,m,g,l[d+11],10,3174756917),g=s(g,v,u,m,l[d+2],15,718787259),m=s(m,g,v,u,l[d+9],21,3951481745),u=i(u,p),m=i(m,c),g=i(g,h),v=i(v,f);return(a(u)+a(m)+a(g)+a(v)).toLowerCase()}("config.mlve"),r=null;for(var s in o.files)if(s===n){r=await o.file(s).async("string");break}if(!r)throw new Error("未找到 config.mlve 文件");for(var a=JSON.parse(r),l={},d={},p={},c=0;c<a.list.length;c++)for(var h=a.list[c],f=0;f<h.costume.length;f++){var u=h.costume[f];""!==u.path&&await this.extractModelJson(o,u.path,a,t,l,d,p)}for(var m in l)if(l.hasOwnProperty(m)){var g=l[m];for(var v in d)d.hasOwnProperty(v)&&(g=g.replace(new RegExp(v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),d[v]));p[m]=(new TextEncoder).encode(g)}return{files:p,modelFileName:Object.keys(l)[0]}}async extractModelJson(e,t,i,s,l,d,p){if(!d[t]){var c=await e.file(t).async("uint8array"),h=o(a(i,t,s),c);try{var f=new TextDecoder("utf-8").decode(h),u=JSON.parse(f);u.FileReferences&&u.FileReferences.PhysicsV2&&delete u.FileReferences.PhysicsV2;var m=Object.keys(l).length,g="model"+m+".model3.json";for(var v of(l[g]=JSON.stringify(u),d[t]=g,r(u))){var w=v[0],b=v[1];if((w.toLowerCase().endsWith("_command")||w.toLowerCase().endsWith("_postcommand"))&&b){var y=b.split(";");for(var M of y){var j=n(M);if(j)if(M.startsWith("change_cos"))await this.extractModelJson(e,j,i,s,l,d,p);else{var x=w+"_"+m,O=await this.recoveryFile(e,j,i,s,x,p);d[j]=O[0]}}}if(/^[0-9a-f]{32}\.bin3?$/.test(b)){if(d[b])continue;var C=w+"_"+m,R=await this.recoveryFile(e,b,i,s,C,p);d[b]=R[0]}}}catch(e){throw e}}}async recoveryFile(e,t,i,n,r,s){var l=await e.file(t).async("uint8array"),d=o(a(i,t,n),l),p=function(e){if(e.length>3&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3])return".png";if(e.length>3&&255===e[0]&&216===e[1]&&255===e[2])return".jpg";if(e.length>11&&82===e[0]&&73===e[1]&&70===e[2]&&70===e[3]&&87===e[8]&&69===e[9]&&66===e[10]&&80===e[11])return".webp";if(e.length>5&&71===e[0]&&73===e[1]&&70===e[2])return".gif";if(e.length>3&&77===e[0]&&79===e[1]&&67===e[2]&&51===e[3])return".moc3";if(e.length>2&&73===e[0]&&68===e[1]&&51===e[2])return".moc";if(e.length>3&&255===e[0]&&251===e[1])return".mp3";if(e.length>11&&82===e[0]&&73===e[1]&&70===e[2]&&70===e[3]&&(87!==e[8]||69!==e[9]||66!==e[10]||80!==e[11]))return".wav";try{const t=new TextDecoder("utf-8").decode(e);return JSON.parse(t),".json"}catch(e){return""}}(d),c=function(e){const t=e.toLowerCase().substring(e.lastIndexOf(".")),i=e.toLowerCase();return-1!==[".png",".jpg",".jpeg",".webp",".gif",".bmp",".tga"].indexOf(t)?"textures/"+e:-1!==i.indexOf("motion")&&".json"===t?-1!==i.indexOf("idle")?("motions/idle/"+e).replace(".json",".motion3.json"):-1!==i.indexOf("tap")||-1!==i.indexOf("touch")?("motions/tap/"+e).replace(".json",".motion3.json"):-1!==i.indexOf("flick")?("motions/flick/"+e).replace(".json",".motion3.json"):-1!==i.indexOf("pinch")?("motions/pinch/"+e).replace(".json",".motion3.json"):("motions/"+e).replace(".json",".motion3.json"):-1===i.indexOf("expression")&&-1===i.indexOf("exp")||".json"!==t?-1!==i.indexOf("physics")&&".json"===t?("physics/"+e).replace(".json",".physic3.json"):-1!==i.indexOf("pose")&&".json"===t?("pose/"+e).replace(".json",".pose.json"):-1!==i.indexOf("effect")&&".json"===t?"effects/"+e:-1!==i.indexOf("userdata")&&".json"===t?"userdata/"+e:-1!==[".wav",".mp3",".ogg"].indexOf(t)?"sounds/"+e:(".moc3"===t||i.endsWith(".model3.json"),e):("expressions/"+e).replace(".json",".exp3.json")}(r+p);return s[c]=d,[c,p]}setupInterceptors(){var e=this,t=window.fetch;window.fetch=function(i,o){var n="string"==typeof i?i:i.toString(),r=n.split("/").pop().toLowerCase();for(var s in e.fileDataUrls)if(e.fileDataUrls.hasOwnProperty(s)){var a=s.split("/").pop().toLowerCase();if(-1!==n.indexOf(s)||r===a)return fetch(e.fileDataUrls[s])}return t.apply(this,arguments)};var i=window.XMLHttpRequest;window.XMLHttpRequest=function(){var t=new i,o=t.open,n=t.send,r="",s="";return t.open=function(e,t){return r=t,o.apply(this,arguments)},Object.defineProperty(t,"responseType",{get:function(){return s},set:function(e){s=e},configurable:!0}),t.send=function(){var i=r?r.split("/").pop():"";for(var o in e.fileDataUrls)if(e.fileDataUrls.hasOwnProperty(o)){var a=o.split("/").pop();if(r&&(-1!==r.indexOf(o)||i===a)){var l=e.fileDataUrls[o];if(l.startsWith("data:")){for(var d=l.split(",")[1],p=window.atob(d),c=new Uint8Array(p.length),h=0;h<p.length;h++)c[h]=p.charCodeAt(h);return void setTimeout((function(){if(Object.defineProperty(t,"readyState",{value:4,writable:!0}),Object.defineProperty(t,"status",{value:200,writable:!0}),Object.defineProperty(t,"statusText",{value:"OK",writable:!0}),Object.defineProperty(t,"responseURL",{value:r,writable:!0}),o.endsWith(".json")||"json"===s){var e=new TextDecoder("utf-8").decode(c);Object.defineProperty(t,"responseText",{value:e,writable:!0});try{var i=JSON.parse(e);Object.defineProperty(t,"response",{value:i,writable:!0})}catch(i){Object.defineProperty(t,"response",{value:e,writable:!0})}}else if("arraybuffer"===s)Object.defineProperty(t,"response",{value:c.buffer,writable:!0});else if("blob"===s){var n=new Blob([c]);Object.defineProperty(t,"response",{value:n,writable:!0})}else Object.defineProperty(t,"response",{value:c.buffer,writable:!0});t.readyState=4;var a=new Event("readystatechange");t.dispatchEvent(a);var l=new Event("load");t.dispatchEvent(l),t.onload&&t.onload(l),t.onreadystatechange&&t.onreadystatechange(a)}),0)}}}return n.apply(this,arguments)},t}}async initPixi(e){var t=this.extractedFiles[e],i=new TextDecoder("utf-8").decode(t),o=JSON.parse(i),n=this,r=function(e){if("string"==typeof e){var t=!1;for(var i of[".png",".jpg",".jpeg",".webp",".gif",".bmp",".tga"])if(e.toLowerCase().endsWith(i)){t=!0;break}if(t){var o=e.split("/").pop().toLowerCase();for(var s in n.fileDataUrls)if(n.fileDataUrls.hasOwnProperty(s)){var a=s.split("/").pop().toLowerCase();if(e===s||e.endsWith("/"+s)||o===a)return n.fileDataUrls[s]}}return e}if(Array.isArray(e))return e.map((function(e){return r(e)}));if("object"==typeof e&&null!==e){var l={};for(var d in e)e.hasOwnProperty(d)&&(l[d]=r(e[d]));return l}return e};if((o=r(o)).url="data:application/json;base64,eyJtb2RlbCI6InRlc3QifQ==",o.FileReferences&&o.FileReferences.Motions)for(var s=this.options.excludeMotions||[],a=0;a<s.length;a++){var l=s[a];o.FileReferences.Motions[l]&&delete o.FileReferences.Motions[l]}var d=this.getResponsiveOption("width","mobileWidth"),p=this.getResponsiveOption("height","mobileHeight");this.app=new PIXI.Application({view:this.canvas,width:d,height:p,backgroundAlpha:0,resolution:window.devicePixelRatio||1,autoDensity:!0,antialias:!0});var c=window.PIXI.live2d?window.PIXI.live2d.Live2DModel:window.Live2DModel;this.model=await c.from(o),this.app.stage.addChild(this.model);var h=this.options.mobileScale&&this.isMobile()?this.options.mobileScale:this.options.scale,f=this.getResponsiveOption("modelX","mobileModelX"),u=this.getResponsiveOption("modelY","mobileModelY"),m=this.getResponsiveOption("modelYOffset","mobileModelYOffset");this.model.anchor.set(.5,.5),this.model.x=d*f,this.model.y=p*u+m,this.model.scale.set(h),this.collectMotions(o),this.options.clickable&&this.setupInteraction(),this.setupMouseTracking(),this.startRestoreLoop(),this.loaded=!0}collectMotions(e){this.motionGroups={},e.FileReferences&&e.FileReferences.Motions&&(this.motionGroups=e.FileReferences.Motions)}setupInteraction(){if(this.model){var e=this,t=!1,i=0,o=0,n=0,r=0,s=!1;this.model.eventMode="static",this.model.cursor="pointer",this.app.stage.eventMode="static",this.app.stage.hitArea=new PIXI.Rectangle(0,0,this.app.screen.width,this.app.screen.height),this.model.on("pointerdown",(function(a){e.options.draggable&&(t=!0,s=!1,i=a.data.global.x,o=a.data.global.y,n=e.container.offsetLeft,r=e.container.offsetTop)})),this.model.on("pointermove",(function(a){if(t&&e.options.draggable){var l=a.data.global.x-i,d=a.data.global.y-o;(Math.abs(l)>5||Math.abs(d)>5)&&(s=!0),e.container.style.left=n+l+"px",e.container.style.top=r+d+"px"}})),this.model.on("pointerup",(function(){t=!1})),this.model.on("pointerupoutside",(function(){t=!1})),this.model.on("hit",(function(i){if(!t&&!s&&e.options.tapMotion)if(e.isLoopingRestore=!1,e.options.randomMotion){var o=e.options.idleMotion;if((c=Object.keys(e.motionGroups).filter((function(t){return t!==o&&e.motionGroups[t].length>0}))).length>0){var n=c[Math.floor(Math.random()*c.length)],r=Math.floor(Math.random()*e.motionGroups[n].length);console.log("随机播放:",n,"索引:",r),e.playMotion(n,r)}}else{var a=e.options.hitAreaMapping||{};for(var l of(console.log("点击区域:",i),i)){var d=a[l]||l;if(e.motionGroups[d]){var p=e.motionGroups[d];if(p.length>0){r=Math.floor(Math.random()*p.length);return console.log("播放动作:",d,"索引:",r),void e.playMotion(d,r)}}}o=e.options.idleMotion;var c=Object.keys(e.motionGroups);for(var h of c)if(h!==o&&e.motionGroups[h].length>0){r=Math.floor(Math.random()*e.motionGroups[h].length);return console.log("默认播放:",h,"索引:",r),void e.playMotion(h,r)}}}))}}playMotion(e,t){if(this.model&&this.motionGroups[e]){var i=this.motionGroups[e];if(i&&i[t]){var o=i[t];try{this.model.motion(e,t)}catch(e){return void console.error("播放动作失败:",e)}if(o.Sound&&this.options.soundEnabled){var n=o.Sound;for(var r in this.fileDataUrls)if(this.fileDataUrls.hasOwnProperty(r)&&(o.Sound.endsWith(r)||r.endsWith(o.Sound.split("/").pop()))){n=this.fileDataUrls[r];break}new Audio(n).play().catch((function(e){console.log("音频播放失败:",e)}))}}}}setupMouseTracking(){if(this.model){var e=this,t=this.canvas;document.addEventListener("mousemove",(function(i){if(e.model&&e.model.internalModel){var o=t.getBoundingClientRect(),n=o.left+o.width/2,r=o.top+o.height/2,s=(i.clientX-n)/(o.width/2),a=(i.clientY-r)/(o.height/2);s=Math.max(-1,Math.min(1,s)),a=-(a=Math.max(-1,Math.min(1,a))),e.model.internalModel.focusController.focus(s,a)}})),document.addEventListener("touchmove",(function(i){if(e.model&&e.model.internalModel){var o=i.touches[0],n=t.getBoundingClientRect(),r=n.left+n.width/2,s=n.top+n.height/2,a=(o.clientX-r)/(n.width/2),l=(o.clientY-s)/(n.height/2);a=Math.max(-1,Math.min(1,a)),l=-(l=Math.max(-1,Math.min(1,l))),e.model.internalModel.focusController.focus(a,l)}}))}}startRestoreLoop(){var e=this,t=e.options.idleMotion;t&&(this.model.internalModel&&this.model.internalModel.motionManager&&this.model.internalModel.motionManager.stopAllMotions(),setTimeout((function(){e.model.internalModel&&e.model.internalModel.motionManager&&e.model.internalModel.motionManager.stopAllMotions(),e.motionGroups[t]&&e.motionGroups[t].length>0&&(e.isLoopingRestore=!0,e.model.motion(t,0),e.model.on("motion",(function(){e.isLoopingRestore&&e.model.motion(t,0)})))}),100))}showError(e){console.error("Live2D Widget Error:",e),this.container&&(this.container.innerHTML='<div style="color: red; padding: 20px; text-align: center;">加载失败: '+e+"</div>")}destroy(){this.app&&this.app.destroy(!0),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}e.Live2DWidget={init:async function(e){var t=new p(e);return await t.init(),t},quickInit:function(e,t){return(t=t||{}).lpkFile=e,this.init(t)}}}(window);
